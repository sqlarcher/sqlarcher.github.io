const cmt=getElement("comments"),{i18nReplies,i18nReblogs,i18nFavourites,i18nLoading,i18nErr,i18nNocomment}=cmt.dataset,cmtSty=document.createElement("style");cmtSty.textContent=`
    #comments ul{position:relative;}
    #comments ul ul {padding-left:1pc}
    #comments ul > li {border-radius:1ex;overflow:hidden}
    #comments ul::before {z-index:-1;position:absolute;top:0;right:0;bottom:0;left:0;border-left:3pt solid #80808008;border-radius:1ex;content:'';}
    #comments noscript {margin:var(--medskip) 0}
    #discussion-starter {margin-bottom:var(--medskip)}
    #stats {margin-left:auto}
    #mstd-comments, #bsky-comments, #fed-comments {padding:0;list-style:none;width:var(--golden-ratio)}
    #comments li, #comments li > ul {padding-top:1ex;list-style:none}
    .fed-comments {border-left:3pt solid var(--ac);background:#80808008;padding:1rem 2rem 1ex 1rem;overflow:auto}
    .fed-comments.bsky {--ac:#1185fe}
    .fed-comments.mstd {--ac:#563acc}
    .fed-comments > .author {overflow-x:auto;white-space:nowrap}
    .fed-comments > .author > img{margin-right:12pt}
    .fed-comments .content {margin-left:4rem;line-height:calc(var(--baselineStretch) * 1.272)}
    .fed-comments .content p {margin: 1.618rem 0}
    .fed-comments .content a {max-width:100%;vertical-align:bottom;white-space:break-spaces}
    .fed-comments > footer {display:flex;align-items:center;margin-top:1rem;margin-left:3.5rem;white-space:nowrap}
    .fed-comments > footer .stat {display:inline-flex;flex-shrink:0;gap:5pt}
    .attachments, #comments > summary {display:flex;margin:.618pc 0;overflow:auto}
    .attachments > * {flex-shrink:0;width:100%;height:auto}
    .attachments img {width:100%;height:auto}
    .stat > * {display:inline-flex;align-items:center;padding:2pt;color:var(--mid);gap:2pt}
    .stat > *::before {vertical-align:text-top;font-family:'base-ui'}
    .stat > * > span {font-size:0.8em}
    a.replies.active, a.reblogs.active {color:var(--ac)}
    a.favourites.active {color:var(--i3i)}
    .fed-comments .date {margin-left:auto;padding-left:1rem;color:var(--mid);font-size:calc(10pt * var(--fontScale))}
    .bluesky {display:inline-block}
    #join-discussion:hover .blueksy, #join-discussion-bluesky:hover .bluesky {transform-origin:center center;animation:flutter 0.2s alternate infinite}
    @keyframes flutter {from { transform:rotateY(0)}to { transform:rotateY(80deg)}}
    @media (max-width:960px) {
        .fed-comments .content, .fed-comments > footer {margin-left:0}
    }
    @media (max-width:480px) {
        .fed-comments {padding: 1rem 1rem 1ex}
    }
    @media print {
        .fed-comments {position:relative;background:none;padding-bottom:0}
        .fed-comments .date {position:absolute;top:0;right:0}
        .fed-comments .stat {display:none !important}
    }`,document.head.appendChild(cmtSty);const fedRoot=getElement("fed-comments");let replies=0,reblogs=0,favourites=0;const addToCounter=(e,t,n)=>{replies=replies+e,reblogs=reblogs+t,favourites=favourites+n},renderStat=(e,t,n,s)=>`
    <a class='${s} ${e>0?"active":""}' href='${t}' rel='external noreferrer nofollow' aria-label='${n}'>
        <span>${e>0?e:""}</span>
    </a>
`,respondToVisibility=(e,t)=>{const n=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&t()})});n.observe(e)},getURI=(e,t)=>{const n=e.split("/"),s=n[0]==="https:"||n[0]==="http:";return s?t(n):e},checkResponseStatus=e=>{if(!e.ok)throw new Error(`HTTP error, status = ${e.status}`)},mstdRoot=getElement("mstd-comments");if(mstdRoot){var bskyCommentsLoaded,skeetURL,mstdCommentsLoaded=!1;const e=mstdRoot.dataset.url,t=e.split("/")[4],r=e=>`https://${e[2]}/api/v1/statuses/${e[4]}`,n=getURI(e,r);if(n!==e){const e=async()=>{if(mstdCommentsLoaded)return;fedRoot||(mstdRoot.innerHTML=`<span id=mstdIsLoading class=loading>${i18nLoading}</span>`);try{const[s,r]=await Promise.all([fetch(n),fetch(n+`/context`)]),[e,c]=await Promise.all([s.json(),r.json()]);checkResponseStatus(s),checkResponseStatus(r),addToCounter(e.replies_count,e.reblogs_count,e.favourites_count),fedRoot||(getElement("stats").innerHTML=a(e),getElement("mstdIsLoading").remove()),getElement("discussion-starter-content").innerHTML=i(e),replies>0?(mstdRoot.setAttribute("role","feed"),typeof DOMPurify!="undefined"?DOMPurify.sanitize(o(c.descendants,t),{RETURN_DOM_FRAGMENT:!0}):o(c.descendants,t)):fedRoot||(mstdRoot.innerHTML=i18nNocomment),mstdCommentsLoaded=!0,mstdRoot.setAttribute("aria-busy","false")}catch(e){console.error(`Mastodon ${i18nErr}`,e),mstdRoot.innerHTML=`Mastodon ${i18nErr} : ${e}`}};respondToVisibility(mstdRoot,e)}const i=e=>{const t=e.media_attachments.length>0?`<div class='attachments'>${e.media_attachments.map(c).join("")}</div>`:"";return`
            <div data-bionRead-safe>${e.content}</div>
            ${t}
        `},c=e=>{const t={image:()=>`<a href='${e.url}' rel='nofollow'><img src='${e.preview_url}' alt='${e.description}' loading='lazy' /></a>`,video:()=>`<video controls preload='none'><source src='${e.url}' type='${e.mime_type}'></video>`,gifv:()=>`<video autoplay loop muted playsinline><source src='${e.url}' type='${e.mime_type}'></video>`,audio:()=>`<audio controls><source src='${e.url}' type='${e.mime_type}'></audio>`,default:()=>`<a href='${e.url}' rel='nofollow'>${e.type}</a>`};if(t)return(t[e.type]||t.default)()},a=e=>`
        ${renderStat(e.replies_count,e.url,i18nReplies,"replies")}
        ${renderStat(e.reblogs_count,`${e.url}/reblogs`,i18nReblogs,"reblogs")}
        ${renderStat(e.favourites_count,`${e.url}/favourites`,i18nFavourites,"favourites")}
    `,s=e=>{const n=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&quot;").replace(/'/g,"&#039;"),s=n(e.account.display_name);e.account.display_name=s,e.account.emojis.forEach(t=>{e.account.display_name=e.account.display_name.replace(`:${t.shortcode}:`,`<img src='${n(t.static_url)}' alt='Emoji ${t.shortcode}' height='20' width='20' />`)});const o=e=>{let t=`@${e.acct}`;if(!e.acct.includes("@")){const n=new URL(e.url);t+=`@${n.hostname}`}return t},t=document.createElement("li");return t.id=`mstd${e.id}`,t.dataset.date=toISOString(e.created_at),t.innerHTML=`
            <article class='fed-comments mstd'>
                <header class='author'>
                    <img src='${n(e.account.avatar_static)}' height=48 width=48 alt='${o(e.account)}' loading='lazy'/>
                    <a class='has-aria-label' href='${e.account.url}' rel='external noreferrer nofollow' aria-label='${o(e.account)}' aria-description='${s}'>
                        <span>${e.account.display_name}</span>
                    </a>
                </header>
                <div class='content' data-bionRead-safe>${i(e)}</div>
                <footer>
                    <div class='stat'>${a(e)}</div>
                    <a class='date' href='${e.url}' rel='ugc external noreferrer nofollow'>
                        <time datetime='${toISOString(e.created_at)}'>${e.edited_at?"*":""}${formatDate(e.created_at)}</time>
                    </a>
                </footer>
            </article>`,t},o=(e,n)=>{const i=e.filter(e=>e.in_reply_to_id===n);i.forEach(n=>{if(n.in_reply_to_id===t)fedRoot?fedRoot.appendChild(s(n)):mstdRoot.appendChild(s(n));else{const t=e.find(e=>e.id===n.in_reply_to_id);if(t){const e=document.createElement("ul");getElement(`mstd${n.in_reply_to_id}`).appendChild(e).appendChild(s(n))}}o(e,n.id)})}}const bskyRoot=getElement("bsky-comments");if(bskyRoot){bskyCommentsLoaded=!1,skeetURL=bskyRoot.dataset.url;const e=e=>{const t=e.split("/");return t[0]==="at:"?"https://bsky.app/profile/"+t[2]+"/post/"+t[4]:e},a=e=>`at://${e[4]}/app.bsky.feed.post/${e[6]}`,n=(e,t,n)=>`https://cdn.bsky.app/img/${n?"feed_thumbnail":"feed_fullsize"}/plain/${e}/${t}`,s=getURI(skeetURL,a);if(s!==skeetURL){const e=async()=>{if(bskyCommentsLoaded)return;fedRoot||(bskyRoot.innerHTML=`<span id=bskyIsLoading class=loading>${i18nLoading}</span>`);try{const n=await fetch(`https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri=${s}`),e=await n.json();if(checkResponseStatus(n),addToCounter(e.thread.post.replyCount,e.thread.post.repostCount,e.thread.post.likeCount),fedRoot||(getElement("stats").innerHTML=i(e.thread.post),getElement("bskyIsLoading").remove()),mstdRoot||(getElement("discussion-starter-content").innerHTML=`<div data-bionRead-safe>${o(e.thread.post.record)}</div>`),replies>0){bskyRoot.setAttribute("role","feed");const n=typeof DOMPurify!="undefined"?DOMPurify.sanitize(t(e.thread),{RETURN_DOM_FRAGMENT:!0}):t(e.thread);if(fedRoot)fedRoot.appendChild(n);else{bskyRoot.appendChild(n);const e=getElements("#bsky-comments > li[data-date]");sortComment(e)}}else fedRoot||(bskyRoot.innerHTML=i18nNocomment);bskyCommentsLoaded=!0,bskyRoot.setAttribute("aria-busy","false")}catch(e){console.error(`Bluesky ${i18nErr}`,e),bskyRoot.innerHTML=`Bluesky ${i18nErr} : ${e}`}};respondToVisibility(bskyRoot,e)}const r=e=>`
        <div data-bionRead-safe>${o(e.record)}</div>
        ${c(e)}
    `,o=e=>{let o=``;const a=new TextEncoder,i=new TextDecoder,t=new Uint8Array(e.text.length*3);a.encodeInto(e.text,t);var s,n=0;for(const l in e.facets){const a=e.facets[l],r=a.features[0],c=r.$type;if(s="#",c=="app.bsky.richtext.facet#tag"?s=`https://bsky.app/hashtag/${r.tag}`:c=="app.bsky.richtext.facet#link"?s=r.uri:c=="app.bsky.richtext.facet#mention"&&(s=`https://bsky.app/profile/${r.did}`),n<a.index.byteStart){const e=t.slice(n,a.index.byteStart);o+=i.decode(e)}const d=t.slice(a.index.byteStart,a.index.byteEnd);o+=`<a href='${s}' target='_blank' rel='external noreferrer nofollow'>`+i.decode(d)+`</a>`,n=a.index.byteEnd}if(n<t.length){const e=t.slice(n,t.length);o+=i.decode(e)}return`<p>${o.replace(/\n/g,`<br />`)}</p>`},c=e=>{let t=``;if(e.embed){const s=e.author.did,o=e.embed.$type;if(o==="app.bsky.embed.external#view"){const{uri:n,title:s,description:o,thumb:i}=e.embed.external;n.includes(".gif?")?t=`<img src='${n}' title='${s}' alt='${o}' loading='lazy'>`:i&&(t=`<a href='${n}' aria-label='${s}'><img src='${i}' alt='${o}' loading='lazy'></a>`)}else if(o==="app.bsky.embed.images#view"){const o=e.record.embed.images;t=o.map(e=>{const t=n(s,e.image.ref.$link,!0),o=n(s,e.image.ref.$link,!1);return`<a href='${o}' target='_blank'><img src='${t}' alt='${e.alt}' loading='lazy'></a>`}).join("")}else if(o==="app.bsky.embed.video#view"){const n=e.record.embed.video;t=`<video controls poster='${e.embed.thumbnail}' preload='none'><source src='https://bsky.social/xrpc/com.atproto.sync.getBlob?cid=${n.ref.$link}&did=${s}' type='${n.mimeType}'></video>`}return`<div class='attachments'>${t}</div>`}return t},i=t=>`
        ${renderStat(t.replyCount,e(t.uri),i18nReplies,"replies")}
        ${renderStat(t.repostCount,`${e(t.uri)}/reposted-by`,i18nReblogs,"reblogs")}
        ${renderStat(t.likeCount,`${e(t.uri)}/liked-by`,i18nFavourites,"favourites")}
    `,l=t=>{const n=new Date(t.post.record.createdAt);return`
        <li data-date='${toISOString(n)}' id='${t.post.cid}'>
            <article class='fed-comments bsky'>
            <header class='author'>
                <img src='${t.post.author.avatar}' width=48 height=48 alt='${t.post.author.handle}' loading='lazy' />
                <a class='has-aria-label' href='https://bsky.app/profile/${t.post.author.handle}' rel='external noreferrer nofollow' aria-label='@${t.post.author.handle}' aria-description='${t.post.author.displayName}'>
                    <span>${t.post.author.displayName}</span>
                </a>
            </header>
            <div class='content'>${r(t.post)}</div>
            <footer>
                <div class='stat'>${i(t.post)}</div>
                <a class='date' href='${e(t.post.uri)}' rel='ugc external noreferrer nofollow'><time datetime='${toISOString(n)}'>${formatDate(n)}</time></a>
            </footer>
            </article>
        </li>`},t=e=>{const n=document.createDocumentFragment(),s=e=>{const t=document.createElement("li");return t.innerHTML=e.trim(),t.firstChild};for(const o of e.replies){const i=s(l(o));if(o.replies.length>0){const e=document.createElement("ul");i.appendChild(e).appendChild(t(o))}n.appendChild(i)}return n}}const sortComment=e=>{const n=Array.from(e),t=new Set;n.sort(({dataset:{date:e}},{dataset:{date:t}})=>e.localeCompare(t)).forEach(e=>{t.has(e.id)?e.remove():(t.add(e.id),e.parentNode.appendChild(e))})},aggregateComment=()=>{if(mstdCommentsLoaded&&bskyCommentsLoaded){if(replies>0){fedRoot.setAttribute("role","feed");const e=getElements("#fed-comments > li[data-date]");sortComment(e)}else fedRoot.innerHTML=i18nNocomment;getElement("stats").innerHTML=`
            ${renderStat(replies,skeetURL,i18nReplies,"replies")}
            ${renderStat(reblogs,`${skeetURL}/reposted-by`,i18nReblogs,"reblogs")}
            ${renderStat(favourites,`${skeetURL}/liked-by`,i18nFavourites,"favourites")}
        `,bskyRoot.remove(),mstdRoot.remove()}else window.setTimeout(aggregateComment,100)};bskyRoot&&mstdRoot&&aggregateComment()